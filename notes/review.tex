\documentclass[14pt,letterpaper]{article}

% ============ Page Layout ============
\usepackage[margin=1in]{geometry}
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\rhead{Midterm Review}
\lhead{Onur Calisir}
\rfoot{Page \thepage}

% ============ Math Packages ============
\usepackage{amsmath, amssymb, amsthm}
\usepackage{mathtools}  % Enhanced math (e.g., dcases)
\usepackage{bm}         % Bold math symbols (\bm{x})
\usepackage{bbm}        % Blackboard bold for indicators
% \usepackage{algorithm2e}  % for algorithms

% ============ Graphics & Figures ============
\usepackage{graphicx}
\usepackage{tikz}
\usetikzlibrary{bayesnet, arrows.meta, positioning}
\usepackage{float}
\usepackage{tcolorbox}    % for colored boxes
\usepackage{xcolor}      % For colors
\usepackage{colortbl}    % For \rowcolor
% ============ Algorithms ============
\usepackage[ruled,vlined,linesnumbered]{algorithm2e}
\SetKwInput{KwInput}{Input}
\SetKwInput{KwOutput}{Output}

% ============ Code Blocks ============
\usepackage{listings}
\usepackage{xcolor}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    keepspaces=true,
    numbers=left,
    numbersep=5pt,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2
}
\lstset{style=mystyle}

% ============ Theorem Environments ============
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}{Lemma}[section]
\newtheorem{corollary}{Corollary}[section]
\newtheorem{example}{Example}[section]

% ============ Custom Commands ============
% Probability & Statistics
\newcommand{\expect}[1]{\mathbb{E}\left[#1\right]}
\newcommand{\var}[1]{\text{Var}\left(#1\right)}
\newcommand{\cov}[2]{\text{Cov}\left(#1, #2\right)}

% Distributions
\newcommand{\normal}[2]{\mathcal{N}\left(#1; #2\right)}
\newcommand{\uniform}[2]{\mathcal{U}\left(#1; #2\right)}

% Shortcuts
\newcommand{\pcond}[2]{p(#1 \mid #2)}

% State space notation
\newcommand{\state}{\bm{x}}
\newcommand{\obs}{\bm{z}}
\newcommand{\control}{\bm{u}}
\newcommand{\noise}{\bm{w}}
\newcommand{\dt}{\Delta t}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

\DeclareMathOperator{\atantwo}{atan2}
% ============ Hyperlinks ============
\usepackage[colorlinks=true, linkcolor=blue, citecolor=blue, urlcolor=blue]{hyperref}

% ============ Title Info ============
\title{Probabilistic Robotics - Midterm Study Notes}
\author{Onur Calisir}
\date{\today}

\begin{document}
\maketitle
% \tableofcontents
\newpage
\input{bayes_filter_improved.tex}
\newpage
\input{gaussian_filters_improved.tex}
\newpage
\input{robot_motion_improved.tex}
\newpage
\input{localization_improved.tex}
\newpage
\input{transforms.tex}
\newpage
\input{unit_conversion.tex}

\section*{EKF Localization Algorithm for Underwater Robot}

\subsection*{1. STATE VECTOR}

Since the robot has a perfect compass (orientation is always known), we only need to estimate position:

\textbf{State:}
\[
\mathbf{x}_t = \begin{bmatrix} x \\ y \\ z \end{bmatrix}
\]

\subsection*{2. MOTION MODEL}

The robot moves by setting velocities in each direction with Gaussian noise.

\textbf{Control input:}
\[
\mathbf{u}_t = \begin{bmatrix} u_x \\ u_y \\ u_z \end{bmatrix} = \begin{bmatrix} \dot{x} \\ \dot{y} \\ \dot{z} \end{bmatrix} \Delta t
\]

\textbf{Motion model:}
\[
\mathbf{x}_t = \mathbf{x}_{t-1} + \mathbf{u}_t + \boldsymbol{\epsilon}_t
\]
where $\boldsymbol{\epsilon}_t \sim \mathcal{N}(0, \mathbf{R}_t)$ with $\mathbf{R}_t = \text{diag}(\sigma_x^2, \sigma_y^2, \sigma_z^2)$

\textbf{In function form:}
\[
g(\mathbf{x}_{t-1}, \mathbf{u}_t) = \mathbf{x}_{t-1} + \mathbf{u}_t
\]

\textbf{Motion Jacobian:}
\[
\mathbf{G}_t = \frac{\partial g}{\partial \mathbf{x}} = \mathbf{I}_{3 \times 3}
\]

\textit{Why?} Each position component updates independently:
\begin{align*}
x_t &= x_{t-1} + u_x \Rightarrow \frac{\partial x_t}{\partial x_{t-1}} = 1 \\
y_t &= y_{t-1} + u_y \Rightarrow \frac{\partial y_t}{\partial y_{t-1}} = 1 \\
z_t &= z_{t-1} + u_z \Rightarrow \frac{\partial z_t}{\partial z_{t-1}} = 1
\end{align*}

\subsection*{3. MEASUREMENT MODEL}

\textbf{Beacon $j$ location:}
\[
\mathbf{m}_j = \begin{bmatrix} m_x^j \\ m_y^j \\ m_z^j \end{bmatrix} \text{ (known)}
\]

\textbf{What robot measures:} Time-of-flight $\Delta t_j = t_{\text{receive}} - t_{\text{emit}}^j$

\textbf{Actual measurement:} $z_t^j = c \cdot \Delta t_j$ (where $c \approx 1500$ m/s)

This gives the distance from robot to beacon $j$.

\textbf{Expected measurement function:}
\[
h(\mathbf{x}_t, \mathbf{m}_j) = \|\mathbf{x}_t - \mathbf{m}_j\| = \sqrt{(x - m_x^j)^2 + (y - m_y^j)^2 + (z - m_z^j)^2}
\]

\textbf{Measurement model:}
\[
z_t^j = h(\mathbf{x}_t, \mathbf{m}_j) + \delta_j
\]
where $\delta_j \sim \mathcal{N}(0, Q_j)$ and $Q_j = \sigma_{\text{range}}^2$ (scalar)

\subsection*{4. TAYLOR APPROXIMATION (Linearization)}

Define:
\begin{align*}
\Delta x &= x - m_x^j \\
\Delta y &= y - m_y^j \\
\Delta z &= z - m_z^j \\
r &= \sqrt{\Delta x^2 + \Delta y^2 + \Delta z^2}
\end{align*}

\textbf{Compute Jacobian $\mathbf{H}_t^j = \frac{\partial h}{\partial \mathbf{x}}$:}

\[
\frac{\partial h}{\partial x} = \frac{\partial r}{\partial x} = \frac{\partial}{\partial x}\left[\sqrt{\Delta x^2 + \Delta y^2 + \Delta z^2}\right]
\]
\[
= \frac{1}{2} \cdot 2\Delta x \cdot (\Delta x^2 + \Delta y^2 + \Delta z^2)^{-1/2} = \frac{\Delta x}{r}
\]

Similarly:
\[
\frac{\partial h}{\partial y} = \frac{\Delta y}{r}, \quad \frac{\partial h}{\partial z} = \frac{\Delta z}{r}
\]

\textbf{Measurement Jacobian (evaluated at predicted state $\bar{\boldsymbol{\mu}}_t$):}
\[
\mathbf{H}_t^j = \begin{bmatrix} \frac{\Delta x}{r} & \frac{\Delta y}{r} & \frac{\Delta z}{r} \end{bmatrix}
\]

where:
\begin{align*}
\Delta x &= \bar{\mu}_{t,x} - m_x^j \\
\Delta y &= \bar{\mu}_{t,y} - m_y^j \\
\Delta z &= \bar{\mu}_{t,z} - m_z^j \\
r &= \sqrt{\Delta x^2 + \Delta y^2 + \Delta z^2}
\end{align*}

\subsection*{5. COMPLETE EKF ALGORITHM}

\textbf{Initialization:}
\begin{itemize}
\item $\boldsymbol{\mu}_0$ = initial position estimate
\item $\boldsymbol{\Sigma}_0$ = initial covariance ($3 \times 3$)
\end{itemize}

\subsubsection*{PREDICTION STEP:}
\begin{align*}
\bar{\boldsymbol{\mu}}_t &= \boldsymbol{\mu}_{t-1} + \mathbf{u}_t \\
\bar{\boldsymbol{\Sigma}}_t &= \mathbf{G}_t \boldsymbol{\Sigma}_{t-1} \mathbf{G}_t^T + \mathbf{R}_t = \boldsymbol{\Sigma}_{t-1} + \mathbf{R}_t
\end{align*}
(Note: $\mathbf{G}_t = \mathbf{I}$, so this simplifies)

\subsubsection*{CORRECTION STEP (for each beacon measurement $j$):}

\textbf{1) Compute expected measurement:}
\[
\hat{z}_t^j = \sqrt{(\bar{\mu}_{t,x} - m_x^j)^2 + (\bar{\mu}_{t,y} - m_y^j)^2 + (\bar{\mu}_{t,z} - m_z^j)^2}
\]

\textbf{2) Compute measurement Jacobian:}
\begin{align*}
\Delta x &= \bar{\mu}_{t,x} - m_x^j \\
\Delta y &= \bar{\mu}_{t,y} - m_y^j \\
\Delta z &= \bar{\mu}_{t,z} - m_z^j \\
r &= \sqrt{\Delta x^2 + \Delta y^2 + \Delta z^2} \\
\mathbf{H}_t^j &= \begin{bmatrix} \frac{\Delta x}{r} & \frac{\Delta y}{r} & \frac{\Delta z}{r} \end{bmatrix}
\end{align*}

\textbf{3) Innovation covariance:}
\[
S_t^j = \mathbf{H}_t^j \bar{\boldsymbol{\Sigma}}_t (\mathbf{H}_t^j)^T + Q_j \quad \text{(scalar)}
\]

\textbf{4) Kalman gain:}
\[
\mathbf{K}_t^j = \bar{\boldsymbol{\Sigma}}_t (\mathbf{H}_t^j)^T (S_t^j)^{-1} \quad \text{($3 \times 1$ vector)}
\]

\textbf{5) Update mean:}
\[
\bar{\boldsymbol{\mu}}_t = \bar{\boldsymbol{\mu}}_t + \mathbf{K}_t^j (z_t^j - \hat{z}_t^j)
\]

\textbf{6) Update covariance:}
\[
\bar{\boldsymbol{\Sigma}}_t = (\mathbf{I} - \mathbf{K}_t^j \mathbf{H}_t^j) \bar{\boldsymbol{\Sigma}}_t
\]

\textbf{After all measurements:}
\begin{align*}
\boldsymbol{\mu}_t &= \bar{\boldsymbol{\mu}}_t \\
\boldsymbol{\Sigma}_t &= \bar{\boldsymbol{\Sigma}}_t
\end{align*}

\subsection*{KEY INSIGHTS:}
\begin{enumerate}
\item \textbf{Motion model is LINEAR} $\Rightarrow$ $\mathbf{G}_t = \mathbf{I}$ (no linearization error in prediction)
\item \textbf{Measurement model is NONLINEAR} $\Rightarrow$ Need Jacobian $\mathbf{H}_t^j$
\item \textbf{Range-only measurements} (no bearing) $\Rightarrow$ Each beacon gives distance only
\item \textbf{Multiple beacons} improve localization (triangulation in 3D)
\item \textbf{Known correspondence} $\Rightarrow$ We know which beacon sent each signal
\end{enumerate}
\end{document}
